<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>تحليل جدوى عقار</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f6fbf6;
      --card: #ffffff;
      --text: #1f2d27;
      --muted: #5f6c64;
      --accent: #1f8f68;
      --accent-2: #f3c969;
      --border: #e2e8e2;
      --shadow: 0 14px 30px rgba(31, 143, 104, 0.08);
      --radius: 14px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'IBM Plex Sans Arabic', system-ui, sans-serif;
      background: linear-gradient(140deg, #f9fdf8 0%, #f3f9f2 45%, #fdfbf4 100%);
      color: var(--text);
      direction: rtl;
      padding: 24px;
      min-height: 100vh;
      min-height: 100dvh;
      -webkit-text-size-adjust: 100%;
      -webkit-tap-highlight-color: transparent;
      font-weight: 400;
    }

    button,
    .mode-switcher button,
    .switcher button,
    input,
    select {
      font-family: 'IBM Plex Sans Arabic', system-ui, sans-serif;
      font-weight: 600;
    }

    h1 {
      margin: 0 0 6px;
      font-size: 1.75rem;
      font-weight: 700;
    }

    p.lead {
      margin: 0 0 16px;
      color: var(--muted);
    }

    .page {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px 18px 20px;
      box-shadow: var(--shadow);
    }

    .card h2 {
      margin: 0 0 12px;
      font-size: 1.1rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .helper-text {
      font-size: 0.92rem;
      color: var(--muted);
    }

    .actions-row {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 10px;
      flex-wrap: wrap;
      margin: 6px 0 10px;
    }

    .btn {
      appearance: none;
      border: none;
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
      box-shadow: 0 10px 20px rgba(31, 143, 104, 0.15);
      color: #0f553f;
      background: linear-gradient(135deg, var(--accent), #26a778);
      min-height: 44px;
    }

    .btn.secondary {
      background: #f7f9f8;
      color: var(--text);
      box-shadow: none;
      border: 1px solid var(--border);
    }

    .btn:active {
      transform: translateY(1px);
    }

    .summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 8px;
    }

    .summary .item,
    .input-card {
      background: #fdfefc;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      box-shadow: none;
    }

    .summary .item .label,
    .input-card label {
      color: var(--muted);
      font-size: 0.92rem;
      font-weight: 600;
    }

    .summary .item .value {
      font-weight: 700;
      font-size: 1.05rem;
      color: var(--text);
      direction: ltr;
    }

    .inputs-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 12px;
    }

    .input-wrap {
      display: flex;
      align-items: center;
      background: #f9fbf9;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
      gap: 8px;
      min-height: 44px;
    }

    .input-wrap input {
      border: none;
      background: transparent;
      font-size: 1rem;
      width: 100%;
      color: var(--text);
      outline: none;
      direction: ltr;
      text-align: right;
      min-height: 28px;
    }

    .unit {
      color: var(--muted);
      font-size: 0.9rem;
      white-space: nowrap;
    }

    .switch-toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      color: var(--muted);
      margin-top: 4px;
      user-select: none;
    }

    .switch-toggle input {
      appearance: none;
      width: 42px;
      height: 24px;
      border-radius: 999px;
      background: #d9e6df;
      position: relative;
      outline: none;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .switch-toggle input::after {
      content: '';
      position: absolute;
      top: 3px;
      right: 3px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
      transition: transform 0.2s ease;
    }

    .switch-toggle input:checked {
      background: rgba(31, 143, 104, 0.5);
    }

    .switch-toggle input:checked::after {
      transform: translateX(-18px);
    }

    .decision {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 12px;
      font-weight: 700;
      margin-top: 6px;
    }

    .decision.good {
      background: rgba(31, 143, 104, 0.12);
      color: var(--accent);
      border: 1px solid rgba(31, 143, 104, 0.2);
    }

    .decision.bad {
      background: rgba(243, 89, 89, 0.1);
      color: #c13c3c;
      border: 1px solid rgba(243, 89, 89, 0.2);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(31, 143, 104, 0.08);
      color: var(--accent);
      border-radius: 999px;
      padding: 6px 10px;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .table-wrapper {
      overflow-x: auto;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fff;
      box-shadow: var(--shadow);
      -webkit-overflow-scrolling: touch;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1200px;
    }

    th, td {
      padding: 10px 12px;
      text-align: right;
      border-bottom: 1px solid var(--border);
      font-size: 0.95rem;
      white-space: nowrap;
    }

    thead th {
      position: sticky;
      top: 0;
      background: #fdfefc;
      z-index: 2;
      font-weight: 700;
      color: var(--text);
    }

    tbody tr:hover {
      background: #f9fcf8;
    }

    .switcher,
    .mode-switcher {
      display: inline-flex;
      gap: 8px;
      padding: 6px;
      background: #f8fbfa;
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .switcher button,
    .mode-switcher button {
      border: none;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
      background: transparent;
      color: var(--muted);
      transition: background 0.2s ease, color 0.2s ease;
      min-height: 44px;
    }

    .switcher button.active,
    .mode-switcher button.active {
      background: rgba(31, 143, 104, 0.12);
      color: var(--accent);
    }

    .compact-hidden { display: table-cell; }
    .compact .compact-hidden { display: none; }

    @media (max-width: 1024px) {
      body { padding: 18px; }
      table { min-width: 1100px; }
    }

    @media (max-width: 768px) {
      body { padding: 16px; }
      .inputs-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
      table { min-width: 1000px; }
      .btn { width: 100%; justify-content: center; }
      .actions-row { width: 100%; }
    }

    @media (max-width: 480px) {
      body { padding: 14px; }
      h1 { font-size: 1.4rem; }
      .inputs-grid { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
      table { min-width: 900px; }
      .switcher { width: 100%; justify-content: center; }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>تحليل جدوى عقار (توقعات سنوية)</h1>
      <p class="lead">عدّل المدخلات لترى الأثر مباشرة على التدفقات النقدية والعوائد.</p>
    </header>

    <section class="card inputs-card">
      <h2>المدخلات</h2>
      <p class="helper-text">كل المدخلات متاحة أعلى الصفحة وتؤثر مباشرة على النتائج.</p>
      <div class="actions-row">
        <div class="mode-switcher" aria-label="تبديل وضع المدخلات">
          <button type="button" data-mode="simple" class="active">مبسّط</button>
          <button type="button" data-mode="advanced">متقدّم</button>
        </div>
        <button class="btn secondary" id="resetBtn" type="button">إعادة تعيين</button>
        <button class="btn secondary" id="exportCsv" type="button">تصدير CSV</button>
      </div>
      <div class="inputs-grid" id="inputsGrid"></div>
    </section>

    <section class="card">
      <h2>ملخص سريع</h2>
      <p class="helper-text">أرقام سنة البداية مع شارة قرار بناءً على DSCR والربح الشهري.</p>
      <div id="decision" class="decision">—</div>
      <div class="summary" id="summaryGrid"></div>
    </section>

    <section class="card table-card">
      <header style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
        <div>
          <h2>النتائج المتوقعة</h2>
          <p class="helper-text">تصفح السنوات وشاهد ترويسة الجدول ثابتة أثناء التمرير.</p>
        </div>
        <div class="switcher" aria-label="تبديل عرض الجدول">
          <button type="button" data-view="full" class="active">عرض كامل</button>
          <button type="button" data-view="compact">عرض مختصر</button>
        </div>
      </header>
      <div class="table-wrapper" id="tableWrapper" style="margin-top:14px;">
        <table id="resultsTable">
          <thead>
            <tr>
              <th>العام</th>
              <th>قيمة العقار</th>
              <th>الإيجار السنوي</th>
              <th>الإيجار الشهري</th>
              <th class="compact-hidden">القسط السنوي</th>
              <th>القسط الشهري</th>
              <th class="compact-hidden">صافي الربح السنوي</th>
              <th>صافي الربح الشهري</th>
              <th class="compact-hidden">العائد على المقدم</th>
              <th class="compact-hidden">NOI قبل القسط</th>
              <th>DSCR</th>
              <th>Break-even rent</th>
              <th>هامش الأمان الشهري</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    const debounceDelay = 150;

    const defaults = {
      capitalGrowth: 3.0,
      rentGrowth: 3.0,
      rentYield: 7.0,
      downPct: 30.0,
      downPayment: 120000,
      price0: 400000,
      rateAnnual: 3.4,
      termYears: 25,
      vacancy: 4.0,
      opexPct: 5.0,
      fixedAnnual: 0,
      startYear: 2026,
      endYear: 2050,
      dscrThreshold: 1.25,
    };

    const fieldsConfig = [
      { key: 'capitalGrowth', label: 'النمو الرأسمالي المتوقع', unit: '%', step: '0.1' },
      { key: 'rentGrowth', label: 'النمو في الإيجارات', unit: '%', step: '0.1' },
      { key: 'rentYield', label: 'العائد التأجيري', unit: '%', step: '0.1' },
      { key: 'downPct', label: 'نسبة المقدم', unit: '%', step: '0.1' },
      { key: 'downPayment', label: 'الدفعة الأولى', unit: 'ريال', step: '100' },
      { key: 'price0', label: 'قيمة العقار', unit: 'ريال', step: '1000' },
      { key: 'rateAnnual', label: 'الفائدة السنوية', unit: '%', step: '0.01' },
      { key: 'termYears', label: 'مدة التمويل', unit: 'سنوات', step: '1' },
      { key: 'vacancy', label: 'نسبة الشغور/الفراغ', unit: '%', step: '0.1' },
      { key: 'opexPct', label: 'مصاريف تشغيل من الإيجار', unit: '%', step: '0.1' },
      { key: 'fixedAnnual', label: 'مصاريف ثابتة سنوية', unit: 'ريال', step: '100' },
      { key: 'startYear', label: 'سنة البداية', unit: '', step: '1' },
      { key: 'endYear', label: 'سنة النهاية', unit: '', step: '1' },
      { key: 'dscrThreshold', label: 'حد DSCR للنجاح', unit: '', step: '0.05' },
    ];

    const state = { ...defaults };
    const inputsGrid = document.getElementById('inputsGrid');
    const resultsTableBody = document.querySelector('#resultsTable tbody');
    const summaryGrid = document.getElementById('summaryGrid');
    const decisionEl = document.getElementById('decision');
    const exportBtn = document.getElementById('exportCsv');
    const resetBtn = document.getElementById('resetBtn');
    const switcher = document.querySelector('.switcher');
    const modeSwitcher = document.querySelector('.mode-switcher');
    const tableWrapper = document.getElementById('tableWrapper');

    const simplifiedKeys = ['rentYield', 'price0', 'rateAnnual', 'downPct', 'dscrThreshold'];
    let downLocked = true;
    let advancedLockState = false;
    let currentMode = 'simple';
    let debounceTimer;

    const numberFormatter = (decimals = 0) => new Intl.NumberFormat('en-US', {
      minimumFractionDigits: decimals,
      maximumFractionDigits: decimals,
    });

    const fmt0 = numberFormatter(0);
    const fmt2 = numberFormatter(2);

    function createInputs() {
      const currentValues = { ...state };
      inputsGrid.innerHTML = '';
      const modeKeys = currentMode === 'simple' ? simplifiedKeys : fieldsConfig.map(f => f.key);

      fieldsConfig.forEach(cfg => {
        if (!modeKeys.includes(cfg.key)) return;
        const card = document.createElement('div');
        card.className = 'input-card';
        card.dataset.key = cfg.key;

        const label = document.createElement('label');
        label.setAttribute('for', cfg.key);
        label.textContent = cfg.label + (cfg.unit ? ' (' + cfg.unit + ')' : '');

        const wrap = document.createElement('div');
        wrap.className = 'input-wrap';

        const input = document.createElement('input');
        input.id = cfg.key;
        input.name = cfg.key;
        input.type = 'number';
        input.step = cfg.step;
        input.value = currentValues[cfg.key] ?? defaults[cfg.key];
        input.dataset.key = cfg.key;
        input.min = '0';
        if (cfg.key === 'downPayment') {
          input.disabled = currentMode === 'advanced' ? !downLocked : true;
        }

        const unit = document.createElement('span');
        unit.className = 'unit';
        unit.textContent = cfg.unit || '';

        wrap.appendChild(input);
        wrap.appendChild(unit);
        card.appendChild(label);
        card.appendChild(wrap);

        if (cfg.key === 'downPayment' && currentMode === 'advanced') {
          const toggle = document.createElement('label');
          toggle.className = 'switch-toggle';
          toggle.innerHTML = '<span>قفل الدفعة الأولى</span>';
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.id = 'lockToggle';
          checkbox.checked = downLocked;
          toggle.prepend(checkbox);
          card.appendChild(toggle);

          checkbox.addEventListener('change', () => {
            downLocked = checkbox.checked;
            advancedLockState = downLocked;
            input.disabled = !downLocked;
            if (!downLocked) {
              syncDownPaymentFromPct();
            }
            triggerRecalc();
          });
        }

        if (cfg.key === 'downPct' && currentMode === 'simple') {
          const note = document.createElement('div');
          note.className = 'helper-text';
          const price = parseFloat(state.price0 || defaults.price0);
          const pct = parseFloat(state.downPct || defaults.downPct);
          const computedDown = Math.round(price * (pct / 100));
          note.textContent = `الدفعة الأولى المحسوبة: ${fmt0.format(computedDown)} ريال`;
          card.appendChild(note);
        }

        inputsGrid.appendChild(card);
      });
    }

    function getInputValue(key) {
      return parseFloat(state[key] ?? defaults[key] ?? 0);
    }

    function syncDownPaymentFromPct() {
      const price = getInputValue('price0');
      const downPct = getInputValue('downPct') / 100;
      const value = price * downPct;
      state.downPayment = Math.round(value);
      const dpInput = document.getElementById('downPayment');
      if (dpInput) dpInput.value = Math.round(value);
    }

    function syncDownPctFromPayment() {
      const price = getInputValue('price0');
      const dp = getInputValue('downPayment');
      const pct = price > 0 ? (dp / price) * 100 : 0;
      state.downPct = pct;
      const pctInput = document.getElementById('downPct');
      if (pctInput) pctInput.value = pct.toFixed(2);
    }

    function updateSimpleDownNote() {
      const card = inputsGrid.querySelector('[data-key=\"downPct\"]');
      if (!card) return;
      const note = card.querySelector('.helper-text');
      if (!note) return;
      const price = parseFloat(state.price0 || defaults.price0);
      const pct = parseFloat(state.downPct || defaults.downPct);
      const computedDown = Math.round(price * (pct / 100));
      note.textContent = `الدفعة الأولى المحسوبة: ${fmt0.format(computedDown)} ريال`;
    }

    function pmt(rate, nper, pv) {
      if (rate === 0) return -(pv / nper);
      const r1 = Math.pow(1 + rate, nper);
      return -(pv * rate * r1) / (r1 - 1);
    }

    function collectValues() {
      return { ...state };
    }

    function computeRows(vals) {
      const {
        capitalGrowth, rentGrowth, rentYield,
        downPayment, downPct, price0, rateAnnual,
        termYears, vacancy, opexPct, fixedAnnual,
        startYear, endYear,
      } = vals;

      const years = [];
      const start = Math.min(startYear, endYear);
      const end = Math.max(startYear, endYear);
      const loanAmount = price0 - downPayment;
      const monthlyRate = rateAnnual / 100 / 12;
      const periods = termYears * 12;
      const monthlyPayment = pmt(monthlyRate, periods, loanAmount);
      const annualPayment = monthlyPayment * 12;

      const rentAnnual0 = price0 * (rentYield / 100);

      for (let y = start; y <= end; y++) {
        const idx = y - start;
        const price = price0 * Math.pow(1 + capitalGrowth / 100, idx);
        const rentAnnual = rentAnnual0 * Math.pow(1 + rentGrowth / 100, idx);
        const rentMonthly = rentAnnual / 12;

        const NOI = rentAnnual * (1 - vacancy / 100) - rentAnnual * (opexPct / 100) - fixedAnnual;
        const dscr = annualPayment !== 0 ? NOI / Math.abs(annualPayment) : 0;
        const netProfitAnnual = NOI - Math.abs(annualPayment);
        const netProfitMonthly = netProfitAnnual / 12;
        const returnOnDown = downPayment !== 0 ? netProfitAnnual / downPayment : 0;

        const breakEvenDenom = 1 - vacancy / 100 - opexPct / 100;
        const breakEvenMonthly = breakEvenDenom > 0 ? (Math.abs(monthlyPayment) + (fixedAnnual / 12)) / breakEvenDenom : null;

        years.push({
          year: y,
          price,
          rentAnnual,
          rentMonthly,
          annualPayment: Math.abs(annualPayment),
          monthlyPayment: Math.abs(monthlyPayment),
          netProfitAnnual,
          netProfitMonthly,
          returnOnDown,
          NOI,
          dscr,
          breakEvenMonthly,
          safetyMonthly: netProfitMonthly,
        });
      }
      return { rows: years, loanAmount, monthlyPayment, annualPayment };
    }

    function renderSummary(rows, monthlyPayment, annualPayment, downPayment) {
      summaryGrid.innerHTML = '';
      if (!rows.length) return;
      const first = rows[0];
      const items = [
        { label: 'القسط الشهري', value: fmt0.format(first.monthlyPayment) },
        { label: 'القسط السنوي', value: fmt0.format(first.annualPayment) },
        { label: 'الإيجار الشهري', value: fmt0.format(first.rentMonthly) },
        { label: 'الإيجار السنوي', value: fmt0.format(first.rentAnnual) },
        { label: 'NOI قبل القسط', value: fmt0.format(first.NOI) },
        { label: 'DSCR', value: fmt2.format(first.dscr) },
        { label: 'Break-even rent (شهري)', value: first.breakEvenMonthly ? fmt0.format(first.breakEvenMonthly) : '—' },
        { label: 'صافي الربح الشهري', value: fmt0.format(first.netProfitMonthly) },
        { label: 'العائد على المقدم', value: fmt2.format(first.returnOnDown * 100) + '%' },
      ];

      items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'item';
        const label = document.createElement('div');
        label.className = 'label';
        label.textContent = item.label;
        const value = document.createElement('div');
        value.className = 'value';
        value.textContent = item.value;
        div.appendChild(label);
        div.appendChild(value);
        summaryGrid.appendChild(div);
      });

      const threshold = getInputValue('dscrThreshold');
      const good = first.dscr >= threshold && first.netProfitMonthly > 0;
      decisionEl.className = 'decision ' + (good ? 'good' : 'bad');
      decisionEl.textContent = good ? 'ناجح' : 'غير مناسب';
      const badge = document.createElement('span');
      badge.className = 'pill';
      badge.textContent = `DSCR ≥ ${fmt2.format(threshold)}`;
      decisionEl.appendChild(badge);
    }

    function renderTable(rows) {
      resultsTableBody.innerHTML = '';
      rows.forEach(r => {
        const tr = document.createElement('tr');
        const cells = [
          r.year,
          fmt0.format(r.price),
          fmt0.format(r.rentAnnual),
          fmt0.format(r.rentMonthly),
          fmt0.format(r.annualPayment),
          fmt0.format(r.monthlyPayment),
          fmt0.format(r.netProfitAnnual),
          fmt0.format(r.netProfitMonthly),
          fmt2.format(r.returnOnDown * 100) + '%',
          fmt0.format(r.NOI),
          fmt2.format(r.dscr),
          r.breakEvenMonthly ? fmt0.format(r.breakEvenMonthly) : '—',
          fmt0.format(r.safetyMonthly),
        ];
        cells.forEach((val, idx) => {
          const td = document.createElement('td');
          td.textContent = val;
          if ([4,6,8,9].includes(idx)) td.classList.add('compact-hidden');
          tr.appendChild(td);
        });
        resultsTableBody.appendChild(tr);
      });
    }

    function triggerRecalc() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        const vals = collectValues();
        if (currentMode === 'simple') {
          syncDownPaymentFromPct();
          vals.downPayment = getInputValue('downPayment');
          updateSimpleDownNote();
        } else if (currentMode === 'advanced' && !downLocked) {
          syncDownPaymentFromPct();
          vals.downPayment = getInputValue('downPayment');
        }
        const { rows, loanAmount, monthlyPayment, annualPayment } = computeRows(vals);
        renderSummary(rows, Math.abs(monthlyPayment), Math.abs(annualPayment), vals.downPayment);
        renderTable(rows);
      }, debounceDelay);
    }

    function exportCSV(rows) {
      if (!rows.length) return;
      const headers = [
        'العام','قيمة العقار','الإيجار السنوي','الإيجار الشهري','القسط السنوي','القسط الشهري','صافي الربح السنوي','صافي الربح الشهري','العائد على المقدم','NOI قبل القسط','DSCR','Break-even rent','هامش الأمان الشهري'
      ];
      const lines = [headers.join(',')];
      rows.forEach(r => {
        lines.push([
          r.year,
          r.price,
          r.rentAnnual,
          r.rentMonthly,
          r.annualPayment,
          r.monthlyPayment,
          r.netProfitAnnual,
          r.netProfitMonthly,
          r.returnOnDown * 100,
          r.NOI,
          r.dscr,
          r.breakEvenMonthly ?? '',
          r.safetyMonthly,
        ].map(v => typeof v === 'number' ? v.toFixed(2) : v).join(','));
      });
      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'investment-forecast.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    function attachEvents() {
      inputsGrid.addEventListener('input', (e) => {
        const key = e.target.dataset.key;
        if (!key) return;
        const val = parseFloat(e.target.value || '0');
        state[key] = isNaN(val) ? 0 : val;
        const isAdvanced = currentMode === 'advanced';
        if (key === 'downPct') {
          if (isAdvanced && !downLocked) {
            syncDownPaymentFromPct();
          } else if (!isAdvanced) {
            syncDownPaymentFromPct();
            updateSimpleDownNote();
          }
        }
        if (key === 'price0') {
          if (isAdvanced) {
            if (!downLocked) {
              syncDownPaymentFromPct();
            } else {
              syncDownPctFromPayment();
            }
          } else {
            syncDownPaymentFromPct();
            updateSimpleDownNote();
          }
        }
        if (key === 'downPayment' && isAdvanced && downLocked) {
          syncDownPctFromPayment();
        }
        triggerRecalc();
      });

      exportBtn.addEventListener('click', () => {
        const vals = collectValues();
        const { rows } = computeRows(vals);
        exportCSV(rows);
      });

      resetBtn.addEventListener('click', () => {
        Object.assign(state, defaults);
        if (currentMode === 'simple') {
          downLocked = true;
        } else {
          downLocked = advancedLockState = false;
        }
        createInputs();
        if (currentMode === 'advanced' && !downLocked) {
          syncDownPaymentFromPct();
        }
        if (currentMode === 'simple') {
          syncDownPaymentFromPct();
          updateSimpleDownNote();
        }
        triggerRecalc();
      });

      switcher.addEventListener('click', (e) => {
        if (e.target.tagName !== 'BUTTON') return;
        switcher.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');
        const view = e.target.dataset.view;
        if (view === 'compact') {
          tableWrapper.classList.add('compact');
        } else {
          tableWrapper.classList.remove('compact');
        }
      });

      modeSwitcher.addEventListener('click', (e) => {
        if (e.target.tagName !== 'BUTTON') return;
        const mode = e.target.dataset.mode;
        if (mode === currentMode) return;
        modeSwitcher.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');
        if (mode === 'simple') {
          advancedLockState = downLocked;
          downLocked = true;
          currentMode = 'simple';
        } else {
          downLocked = advancedLockState;
          currentMode = 'advanced';
        }
        createInputs();
        if (currentMode === 'simple') {
          syncDownPaymentFromPct();
          updateSimpleDownNote();
        }
        triggerRecalc();
      });
    }

    function init() {
      createInputs();
      attachEvents();
      triggerRecalc();
    }

    init();
  </script>
</body>
</html>
